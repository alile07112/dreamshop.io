<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dream Shop</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    :root{
      --accent:#8b5cf6;
      --accent-2:#06b6d4;
      --muted:rgba(255,255,255,0.78);
      --glass:rgba(255,255,255,0.04);
      --card:rgba(255,255,255,0.03);
      --radius:12px;
      --max-width:980px;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }

    html,body{height:100%;margin:0;background:#f5f7fa;color:#111}
    body{
      background-color:#f5f7fa;display:flex;align-items:flex-start;justify-content:center;padding:28px;font-smoothing:antialiased;
    }

    .app-shell{width:100%;max-width:var(--max-width);background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(16,24,40,0.06)}

    /* Topbar */
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{margin:0;font-size:18px;letter-spacing:0.3px;color:#111}
    .brand small{display:block;color:rgba(17,17,17,0.6);font-size:12px}

    .api-status{font-size:13px;padding:8px 12px;border-radius:999px;background:transparent;color:rgba(17,17,17,0.6)}

    /* Layout */
    .layout{display:flex;gap:18px;padding:18px}
    .sidebar{width:240px;flex:0 0 240px;padding:10px}
    .main{flex:1;padding:6px}

    /* Categories */
    .categories{display:flex;flex-direction:column;gap:10px}
    .cat-btn{padding:10px;border-radius:8px;border:1px solid rgba(16,24,40,0.04);font-weight:600;cursor:pointer;background:transparent;color:rgba(17,17,17,0.8);display:flex;align-items:center;justify-content:space-between}
    .cat-btn.hash,.cat-btn.weed{background:transparent;color:rgba(17,17,17,0.8)}

    /* Grid */
    .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}

    .card{background:#fff;padding:12px;border-radius:8px;border:1px solid rgba(16,24,40,0.04);box-shadow:0 6px 18px rgba(16,24,40,0.04);display:flex;flex-direction:column;gap:10px}

    .media{height:170px;background:#f0f3f7;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .media img,.media video{width:100%;height:100%;object-fit:cover;display:block}

    .meta{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    .meta .title{font-weight:700;color:#111}
    .meta .sub{font-size:13px;color:rgba(17,17,17,0.6)}

    .price-badge{border:1px solid rgba(16,24,40,0.06);color:rgba(17,17,17,0.9);padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;background:transparent}

    .mini-prices{display:flex;gap:8px;flex-wrap:wrap}
    .mini-prices .p{background:transparent;padding:6px 8px;border-radius:8px;font-size:12px;color:rgba(17,17,17,0.6);border:1px solid rgba(16,24,40,0.04)}

    .actions{display:flex;gap:8px}
    .actions button{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(16,24,40,0.04);cursor:pointer;font-weight:700;font-size:14px;background:transparent;color:rgba(17,17,17,0.9)}
    .actions .details{background:transparent}
    .actions .order{background:transparent}

    /* Modals (simple) */
    .modal{display:none;position:fixed;inset:0;background:rgba(16,24,40,0.12);align-items:center;justify-content:center;padding:20px}
    .modal .content{background:#fff;padding:18px;border-radius:10px;max-width:640px;width:100%;box-shadow:0 8px 24px rgba(16,24,40,0.06)}
    .modal h3{margin-top:0;color:#111}
    .close{float:right;cursor:pointer;background:transparent;border:none;color:rgba(17,17,17,0.6);font-size:20px}

    /* Responsive */
    @media (max-width:880px){
      .layout{flex-direction:column}
      .sidebar{width:100%}
    }

    /* Hover & animations */
    .card{transition:all .14s ease}
    .card:hover{transform:translateY(-2px)}

    .cat-btn{transition:all .12s ease}
    .cat-btn:hover{transform:translateY(-1px)}

    textarea,input{box-sizing:border-box;font-family:inherit;font-size:14px}
    textarea:focus,input:focus{outline:none;border-color:rgba(16,24,40,0.08);background:transparent}

    /* Button states */
    button:active{transform:scale(0.995)}
    button:disabled{opacity:0.6;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="topbar">
      <div class="brand">
        <h1>Dream Shop</h1>
        <small>Bot de commande ‚Äî support</small>
      </div>
      <div id="apiStatus" class="api-status">üîÑ Connexion √† l'API...</div>
    </div>

    <div class="layout">
      <aside class="sidebar">
        <div class="categories">
          <button class="cat-btn hash" onclick="showProducts('hash')">HASH <span style="opacity:0.9"></span></button>
          <button class="cat-btn weed" onclick="showProducts('weed')">WEED</button>
        </div>
      </aside>

      <main class="main">
        <div id="categoryView">
          <h2 style="margin:6px 0 12px 0">Choisis une cat√©gorie</h2>
        </div>

        <div id="productsView" style="display:none">
          <button onclick="showHome()" style="margin-bottom:12px;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)">‚Üê Retour</button>
          <h2 id="categoryTitle" style="margin:6px 0 12px 0"></h2>
          <div class="products-grid" id="productsGrid"></div>
        </div>
      </main>
    </div>

    <!-- Modals -->
    <div id="priceModal" class="modal"><div class="content"><button class="close" onclick="closeModal('priceModal')">&times;</button><h3 id="priceModalTitle"></h3><div id="priceList" style="margin:12px 0"></div><div><button onclick="showOrderFromPrice()" style="width:100%;padding:12px;border-radius:10px;background:#10b981;color:#fff;border:none;font-weight:700;cursor:pointer;transition:all .2s ease" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">Commander</button></div></div></div>

    <div id="orderModal" class="modal"><div class="content"><button class="close" onclick="closeModal('orderModal')">&times;</button><h3 id="orderModalTitle"></h3><div id="weightButtons" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px"></div></div></div>

    <div id="addressModal" class="modal"><div class="content"><button class="close" onclick="closeModal('addressModal')">&times;</button><h3>üìç Informations de livraison</h3><textarea id="addressInput" placeholder="Adresse compl√®te" rows="3" style="width:100%;margin-top:12px;border-radius:8px;padding:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);color:#fff;resize:none"></textarea><input id="phoneInput" type="tel" placeholder="T√©l√©phone" style="width:100%;margin-top:10px;border-radius:8px;padding:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);color:#fff"><div style="margin-top:12px"><button onclick="submitOrder()" style="width:100%;padding:12px;border-radius:10px;background:#10b981;color:#fff;border:none;font-weight:700;cursor:pointer;transition:all .2s ease" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">‚úÖ Confirmer</button></div></div></div>

  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // Pour Netlify en prod, garder '/api'
    const API_URL = '/api';

    let currentUser = tg.initDataUnsafe?.user;
    let currentProduct = null;
    let currentCategory = null;
    let selectedWeight = null;
    let selectedPrice = null;
    let apiConnected = false;

    let stock = {hash:[], weed:[]};

    function updateApiStatus(connected, message){
      const el = document.getElementById('apiStatus');
      el.textContent = (connected? '‚úÖ ' : '‚ùå ') + message;
      apiConnected = !!connected;
    }

    async function checkApiConnection(){
      try{
        const r = await fetch(`${API_URL}/api/health`);
        if(!r.ok) throw new Error(r.status);
        const j = await r.json();
        updateApiStatus(true, 'Connect√© au serveur RDP');
        return true;
      }catch(e){
        console.error('API health error',e);
        updateApiStatus(false, 'Serveur RDP inaccessible');
        return false;
      }
    }

    async function loadStock(){
      try{
        const r = await fetch(`${API_URL}/api/stock?v=2`);
        if(!r.ok) throw new Error(r.status);
        stock = await r.json();
        localStorage.setItem('dreamshop_stock_cache', JSON.stringify(stock));
        localStorage.setItem('dreamshop_stock_timestamp', Date.now());
        localStorage.setItem('dreamshop_cache_version', '2');
        updateApiStatus(true, `Connect√© - ${stock.hash.length} hash, ${stock.weed.length} weed`);
      }catch(e){
        console.warn('loadStock failed',e);
        const cached = localStorage.getItem('dreamshop_stock_cache');
        if(cached){
          stock = JSON.parse(cached);
          updateApiStatus(false, 'Mode hors-ligne (cache)');
        }else{
          updateApiStatus(false, 'Aucun stock disponible');
        }
      }
    }

    async function init(){
      // Clear old cache on version mismatch
      const cachedVersion = localStorage.getItem('dreamshop_cache_version');
      if(cachedVersion !== '2'){
        localStorage.removeItem('dreamshop_stock_cache');
        localStorage.removeItem('dreamshop_stock_timestamp');
        localStorage.removeItem('dreamshop_cache_version');
      }
      updateApiStatus(false,'Connexion...');
      await checkApiConnection();
      await loadStock();
      tg.ready();
    }

    function showHome(){
      document.getElementById('productsView').style.display = 'none';
      document.getElementById('categoryView').style.display = 'block';
    }

    async function showProducts(category){
      currentCategory = category;
      document.getElementById('categoryView').style.display = 'none';
      document.getElementById('productsView').style.display = 'block';
      document.getElementById('categoryTitle').textContent = category.toUpperCase();

      await loadStock();
      const grid = document.getElementById('productsGrid');
      const products = stock[category] || [];
      if(products.length===0){ grid.innerHTML = '<div style="padding:20px">üï∏Ô∏è Aucun produit pour l‚Äôinstant.</div>'; return; }

      grid.innerHTML = '';
      products.forEach((product, idx)=>{
        const card = document.createElement('div'); card.className='card';

        // media
        const mediaWrap = document.createElement('div'); mediaWrap.className='media';
        if(product.file_id){
          const vid = document.createElement('video'); vid.controls=true; vid.preload='metadata'; vid.style.width='100%'; vid.style.height='100%'; vid.style.objectFit='cover';
          mediaWrap.appendChild(vid);
          // fetch actual media URL
          (async ()=>{
            try{
              const resp = await fetch(`${API_URL}/video/${product.file_id}`);
              if(resp.ok){ const j = await resp.json(); if(j.media_url) { vid.src = j.media_url; vid.load(); } }
            }catch(e){ console.warn('media fetch',e); }
          })();
        } else if(product.image && product.image.startsWith('http')){
          const img = document.createElement('img'); img.src=product.image; img.alt=product.name; img.onerror=function(){this.src='https://via.placeholder.com/400x250/667eea/ffffff?text=Produit'}; mediaWrap.appendChild(img);
        } else {
          const ph = document.createElement('div'); ph.style.width='100%'; ph.style.height='100%'; ph.style.display='flex'; ph.style.alignItems='center'; ph.style.justifyContent='center'; ph.style.color='var(--muted)'; ph.textContent='Image indisponible'; mediaWrap.appendChild(ph);
        }

        // meta
        const meta = document.createElement('div'); meta.className='meta';
        const left = document.createElement('div');
        const t = document.createElement('div'); t.className='title'; t.textContent = product.name; left.appendChild(t);
        const s = document.createElement('div'); s.className='sub'; s.textContent = product.stock_total? product.stock_total + ' en stock':''; left.appendChild(s);

        const right = document.createElement('div');
        const minPrice = (product.prices && product.prices.length)? Math.min(...product.prices):null;
        if(minPrice) right.innerHTML = `<div class="price-badge">√Ä partir de ${minPrice}‚Ç¨</div>`;

        meta.appendChild(left); meta.appendChild(right);

        // mini prices
        const mini = document.createElement('div'); mini.className='mini-prices';
        if(product.prices && product.prices.length){
          for(let i=0;i<Math.min(3,product.prices.length);i++){ const p = document.createElement('div'); p.className='p'; p.textContent = (product.weights && product.weights[i]? product.weights[i]+'g ':'') + product.prices[i]+'‚Ç¨'; mini.appendChild(p); }
        }

        // actions
        const actions = document.createElement('div'); actions.className='actions';
        const btnD = document.createElement('button'); btnD.className='details'; btnD.textContent='D√©tails'; btnD.onclick = ()=> showPrices(category, idx);
        const btnO = document.createElement('button'); btnO.className='order'; btnO.textContent='Commander'; btnO.onclick = ()=> showOrder(category, idx);
        actions.appendChild(btnD); actions.appendChild(btnO);

        card.appendChild(mediaWrap); card.appendChild(meta); card.appendChild(mini); card.appendChild(actions);
        grid.appendChild(card);
      });
    }

    function showPrices(category, index){
      const product = (stock[category]||[])[index]; if(!product) return;
      currentProduct = {category,index,product};
      document.getElementById('priceModalTitle').textContent = `üí® ${product.name}`;
      const list = document.getElementById('priceList'); list.innerHTML='';
      (product.weights||[]).forEach((w,i)=>{ const d=document.createElement('div'); d.style.padding='6px 0'; d.textContent = `‚öñÔ∏è ${w}g ‚Üí ${product.prices[i]}‚Ç¨`; list.appendChild(d); });
      document.getElementById('priceModal').style.display='flex';
    }

    function showOrderFromPrice(){ closeModal('priceModal'); showOrder(currentProduct.category, currentProduct.index); }

    function showOrder(category,index){ const product = (stock[category]||[])[index]; if(!product) return; currentProduct={category,index,product}; document.getElementById('orderModalTitle').textContent = `‚öñÔ∏è Choisis ton poids pour ${product.name}`; const container=document.getElementById('weightButtons'); container.innerHTML=''; (product.weights||[]).forEach((w,i)=>{ const b=document.createElement('button'); b.textContent = `${w}g - ${product.prices[i]}‚Ç¨`; b.style.cssText = 'padding:8px 12px;border-radius:8px;border:none;background:var(--card);color:var(--muted);cursor:pointer;font-weight:700;transition:all .2s ease'; b.onmouseover = ()=>{ b.style.background='rgba(139,92,246,0.3)'; b.style.color='#fff'; }; b.onmouseout = ()=>{ b.style.background='var(--card)'; b.style.color='var(--muted)'; }; b.onclick = ()=> selectWeight(w,product.prices[i]); container.appendChild(b); }); document.getElementById('orderModal').style.display='flex'; }

    function selectWeight(weight,price){ selectedWeight=weight; selectedPrice=price; closeModal('orderModal'); document.getElementById('addressModal').style.display='flex'; }

    function submitOrder(){ const address=document.getElementById('addressInput').value.trim(); const phone=document.getElementById('phoneInput').value.trim(); if(!address||!phone){ tg.showAlert('‚ö†Ô∏è Remplis tous les champs'); return; } const orderData={ product: currentProduct.product.name, category: currentProduct.category, weight: selectedWeight, price: selectedPrice, address, phone, user: currentUser||{id:0,username:'unknown'} }; tg.sendData(JSON.stringify(orderData)); closeModal('addressModal'); tg.showPopup({title:'‚úÖ Commande envoy√©e',message:`Ta commande pour ${currentProduct.product.name} a bien √©t√© envoy√©e.`,buttons:[{type:'ok'}]}); document.getElementById('addressInput').value=''; document.getElementById('phoneInput').value=''; showHome(); }

    function closeModal(id){ document.getElementById(id).style.display='none'; }
    window.onclick = (e)=>{ if(e.target.classList && e.target.classList.contains('modal')) e.target.style.display='none'; }

    setInterval(async ()=>{ if(apiConnected) await loadStock(); },20000);
    document.addEventListener('visibilitychange', async ()=>{ if(!document.hidden) await loadStock(); });

    init();
  </script>
</body>
</html>
